#!/usr/bin/env bash

set -exu
source ./build/common.sh

export VERSION="2.0.${BITBUCKET_BUILD_NUMBER}"
export ENVIRONMENT="prod-east"
export DOCKER_REGISTRY="docker-proxy.services.atlassian.com"

function loginToDocker {
    set +x # We don't want passwords in the logs
    echo "${PIPELINES_JWT_TOKEN}" | docker login -u="platform-tooling-analytics" --password-stdin ${DOCKER_REGISTRY}
    set -x
}

installNpmDependencies
npm test
loginToDocker
npm run publish-and-deploy
